# Root key for MinIO Tenant Chart
tenant:
  ###
  # The Tenant name
  #
  # Change this to match your preferred MinIO Tenant name.
  name: ssd-ha
  image:
    tag: RELEASE.2025-04-22T22-12-26Z
  ###
  # Root key for dynamically creating a secret for use with configuring root MinIO User
  # Specify the ``name`` and then a list of environment variables.
  #
  # .. important::
  #
  #    Do not use this in production environments.
  #    This field is intended for use with rapid development or testing only.
  #
  # For example:
  #
  # .. code-block:: yaml
  #
  #    name: myminio-env-configuration
  #    accessKey: minio
  #    secretKey: minio123
  #
  configSecret:
    name: ssd-ha-env-configuration
    existingSecret: true

  ###
  # If this variable is set to true, then enable the usage of an existing Kubernetes secret to set environment variables for the Tenant.
  # The existing Kubernetes secret name must be placed under .tenant.configuration.name e.g. existing-minio-env-configuration
  # The secret must contain a key ``config.env``.
  # The values should be a series of export statements to set environment variables for the Tenant.
  # For example:
  #
  # .. code-block:: shell
  #
  #    stringData:
  #       config.env: |-
  #         export MINIO_ROOT_USER=ROOTUSERNAME
  #         export MINIO_ROOT_PASSWORD=ROOTUSERPASSWORD
  #
  #   existingSecret: false
  ###
  # Top level key for configuring MinIO Pool(s) in this Tenant.
  #
  # See `Operator CRD: Pools <https://min.io/docs/minio/kubernetes/upstream/reference/operator-crd.html#pool>`__ for more information on all subfields.
  pools:
    ###
    # The number of MinIO Tenant Pods / Servers in this pool.
    # For standalone mode, supply 1. For distributed mode, supply 4 or more.
    # Note that the operator does not support upgrading from standalone to distributed mode.
    - servers: 4
      ###
      # Custom name for the pool
      name: ssd-ha
      ###
      # The number of volumes attached per MinIO Tenant Pod / Server.
      volumesPerServer: 1
      ###
      # The capacity per volume requested per MinIO Tenant Pod.
      size: 50Gi
      ###
      # The `storageClass <https://kubernetes.io/docs/concepts/storage/storage-classes/>`__ to associate with volumes generated for this pool.
      #
      # If using Amazon Elastic Block Store (EBS) CSI driver
      # Please make sure to set xfs for "csi.storage.k8s.io/fstype" parameter under StorageClass.parameters.
      # Docs: https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/docs/parameters.md
      storageClassName: ssd-ha-xfs
      ###
      #
      # The `Requests or Limits <https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/>`__ for resources to associate to Tenant pods.
      #
      # These settings can control the minimum and maximum resources requested for each pod.
      # If no worker nodes can meet the specified requests, the Operator may fail to deploy.
      resources: { }

  ###
  # Configures a Prometheus-compatible scraping endpoint at the specified port.
  metrics:
    enabled: true
    port: 9000
    protocol: http
  ###
  # Configures external certificate settings for the Tenant.
  certificate:
    ###
    # Enable automatic Kubernetes based `certificate generation and signing <https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster>`__
    requestAutoCert: false
  ###
  # Array of objects describing one or more buckets to create during tenant provisioning.
  # Example:
  # 
  # .. code-block:: yaml
  #
  #    - name: my-minio-bucket
  #      objectLock: false        # optional
  #      region: us-east-1        # optional
  buckets:
    - name: immich-postgresql-backup
      region: ap-northeast-2
  ###
  # Array of Kubernetes secrets from which the Operator generates MinIO users during tenant provisioning.
  # Each element in the array is an object consisting of a key-value pair ``name: <string>``, where the ``<string>`` references an opaque Kubernetes secret.
  # Each secret should specify the ``CONSOLE_ACCESS_KEY`` and ``CONSOLE_SECRET_KEY`` as the access key and secret key for that user.
  # The Operator creates each user with the ``consoleAdmin`` policy by default. You can change the assigned policy after the Tenant starts.
  users:
    - name: cnpg-immich
  ###
  # Directs the Operator to add the Tenant's metric scrape configuration to an existing Kubernetes Prometheus deployment managed by the Prometheus Operator.
  prometheusOperator: false

###
# Configures `Ingress <https://kubernetes.io/docs/concepts/services-networking/ingress/>`__ for the Tenant S3 API and Console.
#
# Set the keys to conform to the Ingress controller and configuration of your choice.
ingress:
  console:
    enabled: true
    ingressClassName: traefik
    annotations:
      cert-manager.io/cluster-issuer: cluster-issuer-acme
      cert-manager.io/private-key-algorithm: ECDSA
      cert-manager.io/private-key-size: '384'
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    tls:
      - hosts:
          - minio.bhyoo.com
        secretName: minio-bhyoo-com
    host: minio.bhyoo.com

# Use an extraResources template section to include additional Kubernetes resources
# with the Helm deployment.
extraResources:
  # language=GoTemplate
  - |-
    apiVersion: generators.external-secrets.io/v1alpha1
    kind: Password
    metadata:
      name: {{ .Values.tenant.name }}-access-key-id
    spec:
      length: 15
      encoding: base32
  # language=GoTemplate
  - |-
    apiVersion: generators.external-secrets.io/v1alpha1
    kind: Password
    metadata:
      name: {{ .Values.tenant.name }}-secret-key
    spec:
      length: 30
      encoding: base64
  # language=GoTemplate
  - |-
    apiVersion: external-secrets.io/v1
    kind: ExternalSecret
    metadata:
      name: {{ .Values.tenant.configSecret.name }}
    spec:
      refreshPolicy: CreatedOnce
      refreshInterval: 0s
      target:
        name: {{ .Values.tenant.configSecret.name }}
        # this is how the Kind=Secret will look like
        template:
          engineVersion: v2
          data:
            accessKeyId: "{{ `{{ .accessKeyId }}` }}"
            secretKey: "{{ `{{ .secretKey }}` }}"
            config.env: |-
              export MINIO_ROOT_USER="{{ `{{ .accessKeyId }}` }}"
              export MINIO_ROOT_PASSWORD="{{ `{{ .secretKey }}` }}"
      dataFrom:
        - sourceRef:
            generatorRef:
              apiVersion: generators.external-secrets.io/v1alpha1
              kind: Password
              name: {{ .Values.tenant.name }}-access-key-id
          rewrite:
            - transform:
                template: "accessKeyId"
        - sourceRef:
            generatorRef:
              apiVersion: generators.external-secrets.io/v1alpha1
              kind: Password
              name: {{ .Values.tenant.name }}-secret-key
          rewrite:
            - transform:
                template: "secretKey"
  # language=GoTemplate
  - |-
    apiVersion: external-secrets.io/v1
    kind: ExternalSecret
    metadata:
      name: cnpg-immich
    spec:
      refreshPolicy: CreatedOnce
      refreshInterval: 0s
      target:
        name: cnpg-immich
        # this is how the Kind=Secret will look like
        template:
          metadata:
            annotations:
              reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
              reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "immich"
          engineVersion: v2
          data:
            CONSOLE_ACCESS_KEY: "{{ `{{ .accessKeyId }}` }}"
            ACCESS_KEY_ID: "{{ `{{ .accessKeyId }}` }}"
            CONSOLE_SECRET_KEY: "{{ `{{ .secretKey }}` }}"
            ACCESS_SECRET_KEY: "{{ `{{ .secretKey }}` }}"
      dataFrom:
        - sourceRef:
            generatorRef:
              apiVersion: generators.external-secrets.io/v1alpha1
              kind: Password
              name: {{ .Values.tenant.name }}-access-key-id
          rewrite:
            - transform:
                template: "accessKeyId"
        - sourceRef:
            generatorRef:
              apiVersion: generators.external-secrets.io/v1alpha1
              kind: Password
              name: {{ .Values.tenant.name }}-secret-key
          rewrite:
            - transform:
                template: "secretKey"
