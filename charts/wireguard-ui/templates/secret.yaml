apiVersion: v1
kind: Secret
metadata:
  name: {{ include "wireguard-ui.fullname" . }}
  labels:
    {{- include "wireguard-ui.labels" . | nindent 4 }}
type: Opaque
data:
  {{- /* https://itnext.io/manage-auto-generated-secrets-in-your-helm-charts-5aee48ba6918 */}}
  {{- /* retrieve the secret data using lookup function and when not exists, return an empty dictionary / map as result */}}
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace (include "wireguard-ui.fullname" .)) | default dict }}
  {{- $secretData := (get $secretObj "data") | default dict }}
  web-password: {{ get $secretData "web-password" | default (randAlphaNum 16 | b64enc) | quote }}
  {{- if .Values.webServer.sessionSecret }}
  session-secret: {{ .Values.webServer.sessionSecret }}
  {{- else }}
  session-secret: {{ get $secretData "session-secret" | default (randAscii 8 | b64enc) | quote }}
  {{- end }}
{{- if and .Values.wgConfig.serverKey.enabled (not .Values.wgConfig.serverKey.externalSecrets.enabled) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "wireguard-ui.fullname" . }}-server-private-key
  labels:
    {{- include "wireguard-ui.labels" . | nindent 4 }}
type: Opaque
stringData:
  private-key: {{ required "A valid .Values.wgConfig.serverKey.privateKey entry required!" .Values.wgConfig.serverKey.privateKey | quote }}
{{- end }}